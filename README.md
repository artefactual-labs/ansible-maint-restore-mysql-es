ansible-maint-restore-mysql-es
==============================

This ansible role can be used to restore the mysql databases and Elasticsearch indices that were backed up with the [companion role `ansible-maint-backup-mysql-es`](https://github.com/artefactual-labs/ansible-maint-backup-mysql-es). Please note that the current MySQL databases and Elasticsearch indices on the target server will be completely replaced by the backup contents (ensure that this is what you want to do before proceeding)

- Ensure that the target host has the backups in the directory `{{ maint_backup_basepath }}/current/` (default value: `/var/artefactual/maint-backups/current`). The backups should have been generated by the companion role `ansible-maint-backup-mysql-es`
- MySQL databases with same names as the backed up ones are deleted (dropped) from the server before restoring from the backups
- To restore the Elasticsearch indices, a snapshot repository is configured in the Elasticsearch server, the backed up repository tarball file (.tgz) is copied to the repository, and then a snapshot restore operation is done


Role Variables
--------------

Refer to [defaults/main.yml](defaults/main.yml).


Example Playbook
----------------

Before running the playbook, ensure that the backed-up data is in the directory
 `/var/artefactual/maint-backups/current` (assuming variable `maint_backup_basepath` is with the role default value):

```yaml
- name: "Restore mysql/ES from backups"
  hosts:
    - targethost
  become: yes
  tasks:
    - import_role: 
        name: "maint-restore-mysql-es"
      tags: maint-restore-mysql-es
```

If you need to restore only the MySQL databases (or only the Elasticsearch indices), use tags when running the playbook (`maint-restore-mysql` or `maint-restore-es`), for example:

```
ansible-playbook playbook-restore.yml -t maint-restore-mysql -l targethost
ansible-playbook playbook-restore.yml -t maint-restore-es -l targethost
```


Restore the databases and indices to a different host
-----------------------------------------------------

It is possible to use this role (`ansible-maint-restore-mysql-es`) and the companion role `ansible-maint-backup-mysql-es` to copy the databases/indices to another host. For example to copy the databases/indices from `oldhost` to `newhost`

1. Run the `ansible-maint-backup-mysql-es` on `oldhost`. The backup files (mysql dumps, ES snapshot tarballs) will be saved to directory
`/var/artefactual/maint-backups/current` of `oldhost`
2. Install MySQL and Elasticsearch in `newhost`
3. Copy the directory `/var/artefactual/maint-backups/current` from `oldhost` to `newhost` (for example, manually using rsync,
or using an ansible playbook)
3. Run the `ansible-maint-restore-mysql-es` on `newhost`


Notes/Limitations
-----------------
- To just restore some but not all the MySQL databases in the backup, remove the unrequired MySQL dump files from `/var/artefactual/maint-backups/current/mysql` before running the restore role.
- Currently it is not possible to selectively restore some of the ES in the snapshot (it will restore all the available indices in the snapshot)


License
-------

BSD

Author Information
------------------

Artefactual Systems